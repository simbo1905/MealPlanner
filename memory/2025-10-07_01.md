# Recipe Database Architecture and Search Implementation

**Date**: 2025-10-07  
**Context**: Prototype/02 Calendar View Enhancement - Recipe Search Database  
**Participants**: User, AI Assistant

---

## Overview

Enhanced prototype/02 with a searchable recipe database that stores recipes in JSON format conforming to RFC 8927 JDT (JSON Typedef) validation schema. The database supports free-text search, ingredient-based filtering, and tag management with browser localStorage persistence.

---

## JDT Schema Specification

### Recipe Structure

```json
{
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "title": { "type": "string", "minLength": 1 },
    "image_url": { "type": "string", "format": "uri" },
    "description": { "type": "string", "maxLength": 250 },
    "notes": { "type": "string" },
    "pre_reqs": {
      "type": "array",
      "items": { "type": "string" },
      "minItems": 0
    },
    "total_time": { "type": "integer", "minimum": 1 },
    "ingredients": {
      "type": "array",
      "items": { "$ref": "#/definitions/ingredient" },
      "minItems": 1
    },
    "steps": {
      "type": "array",
      "items": { "type": "string" },
      "minItems": 1
    }
  },
  "required": [
    "title", "image_url", "description", "notes",
    "pre_reqs", "total_time", "ingredients", "steps"
  ]
}
```

### Ingredient Structure

```json
{
  "type": "object",
  "additionalProperties": false,
  "properties": {
    "name": { "type": "string" },
    "ucum-unit": {
      "type": "string",
      "enum": [
        "cup_us", "cup_m", "cup_imp",
        "tbsp_us", "tbsp_m", "tbsp_imp",
        "tsp_us", "tsp_m", "tsp_imp"
      ]
    },
    "ucum-amount": { "type": "number", "multipleOf": 0.1 },
    "metric-unit": { "type": "string", "enum": ["ml", "g"] },
    "metric-amount": { "type": "number", "multipleOf": 1 },
    "notes": { "type": "string" },
    "allergen-code": {
      "type": "string",
      "enum": [
        "GLUTEN", "CRUSTACEAN", "EGG", "FISH", "PEANUT", "SOY", "MILK", "NUT",
        "CELERY", "MUSTARD", "SESAME", "SULPHITE", "LUPIN", "MOLLUSC",
        "SHELLFISH", "TREENUT", "WHEAT"
      ]
    }
  },
  "required": [
    "name", "ucum-unit", "ucum-amount",
    "metric-unit", "metric-amount", "notes"
  ]
}
```

---

## Technical Architecture

### Module Structure

#### 1. Type Definitions (`src/lib/recipe-types.ts`)
- TypeScript interfaces derived from JDT schema
- Type-safe enums for units and allergen codes
- Exported types: `Recipe`, `Ingredient`, `UcumUnit`, `MetricUnit`, `AllergenCode`

#### 2. Recipe Database Module (`src/lib/recipe-database.ts`)

**Data Storage**
- Hard-coded recipe examples in RECIPES constant
- localStorage for tag persistence only
- Storage key: `mealplanner-recipe-tags-v1`

**API Surface**
```typescript
// Tag Management
loadTags(): string[]                    // Load tags from localStorage
addTag(tag: string): string[]          // Add new tag, returns updated list
removeTag(tag: string): string[]       // Remove tag, returns updated list

// Recipe Retrieval
getAllRecipes(): Recipe[]
getRecipeById(id: string): Recipe | undefined

// Search Functions
searchByText(query: string): Recipe[]
searchByIngredients(tags: string[]): Recipe[]
searchRecipes(textQuery?: string, ingredientTags?: string[]): Recipe[]
```

**Default Tags**
- "chicken"
- "fish"
- "vegetables"

### Search Logic

#### Text Search
- **Input**: Free text query string
- **Behaviour**: Case-insensitive substring match against `title` and `description`
- **Examples**:
  - "roast chicken" → matches "Roast Chicken" recipe
  - "curry" → matches "Vegetable Curry" recipe

#### Ingredient Tag Search
- **Input**: Array of ingredient tag strings
- **Behaviour**: Case-insensitive substring match against ingredient `name` fields
- **Match Type**: ANY tag matches ANY ingredient (OR logic)
- **Examples**:
  - ["chicken"] → matches recipes containing "chicken breast", "whole chicken"
  - ["fish"] → matches recipes containing "white fish fillet"

#### Combined Search
- **Input**: Both text query AND ingredient tags
- **Behaviour**: Intersection of text results AND ingredient results (AND logic)
- **Example**:
  - Text: "curry" + Tags: ["vegetables"] → matches "Vegetable Curry"

#### Multi-Word Tag Support
- **User Input**: Hold modifier key (Shift/Alt/Ctrl/Cmd) while pressing Space
- **Storage**: Tag stored with non-breaking space (U+00A0)
- **Database Search**: Convert non-breaking space to regex pattern matching any whitespace
- **Example**: 
  - Tag: "apple juice" (with nbsp) 
  - Matches: "apple juice", "apple\njuice", "apple\tjuice"

### Tag Creation UX

#### Hash-Tag Syntax
- **Pattern**: `#word` or `#multi word` (with modifier+space)
- **Trigger**: Word boundary character (space, comma, period, etc.)
- **Invalid**: Triggers on every character BEFORE fix (creates "c", "ce", "cel"...)

#### Word Boundary Characters
- Space (` `)
- Comma (`,`)
- Period (`.`)
- Semicolon (`;`)
- Exclamation (`!`)
- Question mark (`?`)

#### Modifier Key Behaviour
- **Any modifier key + Space** → Insert non-breaking space (U+00A0)
- **Supported modifiers**: Shift, Alt, Ctrl, Cmd/Meta
- **Purpose**: Enable multi-word ingredient tags like "apple juice", "soy sauce"

---

## UI/UX Design

### AddMealDialog Component

**Search Input**
- Placeholder: "Search recipes or type #ingredient..."
- Real-time search as user types
- Hash-tag detection with word boundary validation

**Ingredient Tag UI**
- **Button**: "+ Ingredient" dropdown
- **Dropdown**: Shows available tags from `loadTags()`
- **Selected Tags**: Rendered as Badge components with remove (×) button
- **Visual**: `[chicken ×] [vegetables ×]`

**Recipe List**
- Scrollable container (max-height: 400px)
- Each recipe shows: Icon, Title, Total Time
- Empty state: "No recipes found"

### Integration with Calendar

**Recipe → Activity Mapping**
```typescript
Recipe.title → Activity.title
Recipe.total_time → Activity.prepTime (formatted as "X min")
Recipe.title (slugified) → Activity.id prefix
Default values:
  Activity.icon = "utensils"
  Activity.accentColor = "green"
```

---

## Example Recipes

### 1. Spaghetti Bolognese (45 min)
- Ingredients: spaghetti, minced beef, tomato sauce, onion
- Allergens: GLUTEN

### 2. Chicken Stir-Fry (30 min)
- Ingredients: chicken breast, soy sauce, mixed vegetables
- Allergens: SOY

### 3. Fish and Chips (40 min)
- Ingredients: white fish fillet, flour, potatoes
- Allergens: FISH, GLUTEN

### 4. Vegetable Curry (35 min)
- Ingredients: mixed vegetables, coconut milk, curry paste
- Allergens: None

### 5. Roast Chicken (90 min)
- Ingredients: whole chicken, salt and pepper, onion powder, butter, celery
- Allergens: MILK

---

## Implementation Notes

### British English Standards
- All text uses en-GB spelling: "flavour", "savoury", "colourful"
- Professional business writing conventions
- No emojis in code or documentation (unless explicitly requested)

### Mobile-First Constraints
- Touch targets: 44px minimum
- Scrollable areas for recipe lists
- Responsive layout with Tailwind CSS
- Works on 3G networks (localStorage, no API calls)

### LocalStorage Strategy
- **What's stored**: Tag preferences only
- **What's not stored**: Recipe data (hard-coded in module)
- **Key naming**: Prefixed with `mealplanner-` for namespace isolation
- **Persistence**: Tags survive browser refresh

### Future Enhancement Opportunities
- Tag curation UI (user preferences panel)
- Recipe favourites
- Custom recipe creation
- Import/export recipes
- Advanced filtering (by allergen, prep time, etc.)

---

## Technical Decisions

### Why Hard-Coded Recipes?
- **Prototype phase**: Focus on UX validation, not data persistence
- **Performance**: Instant load, no API latency
- **Simplicity**: No backend required for demo
- **Migration path**: Easy to swap for API/database later

### Why LocalStorage for Tags?
- **User preference**: Tag creation is personalisation
- **Lightweight**: Small data footprint
- **No server**: Keeps prototype self-contained
- **Privacy**: Data stays on device

### Why Separate Type Definitions?
- **Modularity**: Types can be imported anywhere
- **Schema validation**: Direct mapping from JDT spec
- **Type safety**: Compile-time validation for recipe structure
- **Documentation**: Types serve as living documentation

---

## Quality Gates

**Checklist Completed**
- [x] Search "roast chicken" returns Roast Chicken recipe
- [x] Tag "chicken" returns Chicken Stir-Fry + Roast Chicken
- [x] Tag "fish" returns Fish and Chips
- [x] Combined search: text="curry" + tag="vegetables" returns Vegetable Curry
- [x] Tag removal updates results
- [x] Tags persist in localStorage across sessions
- [x] Recipe selection adds meal to calendar with correct time

**Pending Fixes**
- [ ] Tag creation requires word boundary (not every character)
- [ ] Modifier key + space inserts non-breaking space for multi-word tags
- [ ] Database search handles non-breaking spaces correctly

---

## Testing Scenarios

### Single-Word Tags
1. Type "#celery" + Space → Tag "celery" created
2. Type "#chicken" + Comma → Tag "chicken" created
3. Type "#fish" + Period → Tag "fish" created

### Multi-Word Tags
1. Type "#apple" + Shift+Space + "juice" + Space → Tag "apple juice" created
2. Type "#soy" + Ctrl+Space + "sauce" + Comma → Tag "soy sauce" created
3. Search matches "apple juice" in ingredients (with any whitespace)

### Combined Search
1. Text: "chicken" + Tag: "vegetables" → Returns recipes with both criteria
2. Text: "" + Tag: ["chicken", "fish"] → Returns all chicken OR fish recipes
3. Text: "curry" + Tag: [] → Returns all curry recipes

---

## Next Actions

1. Fix tag creation to require word boundary characters
2. Implement modifier key detection for non-breaking space insertion
3. Update search to handle non-breaking spaces with regex pattern
4. Test multi-word tag functionality thoroughly
5. Consider adding tag curation UI in future iterations

---

**Project Memory**: This implementation demonstrates user-centered design principles from the MealPlanner constitution - solving real problems (meal planning with ingredient preferences) with the smallest viable solution (localStorage + hard-coded recipes).
